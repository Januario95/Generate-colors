{% load static %}
<html DOCTYPE>
<html>
<head>
    <meta charset="utf-8">
    <style>
        body {
            font-family: Verdana;
        }
        .container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .collaborator table {
            width: 100%;
            border-collapse: collapse;
        }
        .collaborator table th,
        .collaborator table td {
            border: 1px solid #ddd;
        }
        .add-item {
            
        }
        .add-item form {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .row {
            margin-top: 10px;
        }
        input, select {
            height: 31px;
            outline: none;
            padding-left: 6px;
        }
        .table-div {
            max-height: 320px;
            overflow-y: scroll;
        }
        .priority-td {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .priority {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 1px solid #ccc;
        }
        .critical {
            background-color: red;
        }
        .moderate {
            background-color: yellow;
        }
        .low {
            background-color: lightblue;
        }
        .filter-by-category-checkbox {
            display: flex;
            flex-direction: row;
            justify-content: center;
            align-items: center;
        }
        .filter-by-category-checkbox {
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            align-items: center;
        }
        .filter-by-column-name {
            display: flex;
            flex-direction: row;
            justify-content: flex-start;
            align-items: flex-start;
        }
        .filter-by-column-name-checkbox {
            display: flex;
            flex-direction: row;
            justify-content: center;
            align-items: center;
        }
        .name-checkbox {
            display: none;
            flex-direction: row;
            justify-content: center;
            align-items: center;
        }
        .filter-by-category-checkbox div {
            display: flex;
            flex-direction: row;
            justify-content: center;
            align-items: center;
        }
        a {
            text-decoration: none;
        }
        .delete {
            color: red;
        }
        a:hover {
            text-decoration: underline;
        }
        .edit-item {
            
        }
        .urgent-td {
             text-align: center; 
        }
        .urgent-item {
            color: red;
        }
        .not-urgent-item {
            color: teal;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="collaborator">
            <div class="add-item">
                <form method="post">
                    {% csrf_token %}
                    <div class="row">
                        <label htmlfor="id_name">Item Name</label>
                        {{ form.item_name }}
                        
                        <label htmlfor="id_price">Price</label>
                        {{ form.price }}
                        
                        <label htmlfor="id_priority">Urgent</label>
                        {{ form.urgent }}
                    </div>
                    <div class="row">
                        <label htmlfor="id_quantity">Quantity</label>
                        {{ form.quantity }}
                        
                        <label htmlfor="id_category">Category</label>
                        {{ form.category }}
                        
                        <label htmlfor="id_priority">Category</label>
                        {{ form.priority }}
                    </div>
                    <div>
                        <label htmlfor="id_priority">Source</label>
                        {{ form.buy_from }}
                    </div>
                    <input type="submit" class="register-btn" value="Register">
                </form>
            </div>
            <br/>
            <div class="filter-by-category-checkbox">                
                <div>
                    <input type="checkbox" name="by-checkbox" value="low" class="low checkbox-10">
                    <label htmlFor="">Low</label>
                </div>
                <div>
                    <input type="checkbox" name="by-checkbox" value="moderate" class="moderate checkbox-11">
                    <label htmlFor="">Moderate</label>
                </div>
                <div>
                    <input type="checkbox" name="by-checkbox" value="critical" class="critical checkbox-12">
                    <label htmlFor="">Critical</label>
                </div>
                
                
                
                <div>
                    <input type="checkbox" name="by-checkbox" value="hygien" class="hygien checkbox-1">
                    <label htmlFor="">Hygien</label>
                </div>
                <div>
                    <input type="checkbox" name="by-checkbox" value="food" class="food checkbox-2">
                    <label htmlFor="">Food</label>
                </div>
                <div>
                    <input type="checkbox" name="by-checkbox" value="clothes" class="clothes checkbox-3">
                    <label htmlFor="">Clothes</label>
                </div>
                <div>
                    <input type="checkbox" name="by-checkbox" value="documents" class="documents checkbox-4">
                    <label htmlFor="">Documents</label>
                </div>
                <div>
                    <input type="checkbox" name="by-checkbox" value="family" class="family checkbox-5">
                    <label htmlFor="">Family</label>
                </div>
                <div>
                    <input type="checkbox" name="by-checkbox" value="debt" class="debt checkbox-6">
                    <label htmlFor="">Debt</label>
                </div>
                <div>
                    <input type="checkbox" name="by-checkbox" value="house" class="house checkbox-7">
                    <label htmlFor="">House</label>
                </div>
                <div>
                    <input type="checkbox" name="by-checkbox" value="cotas" class="cotas checkbox-8">
                    <label htmlFor="">Cotas</label>
                </div>
                <div>
                    <input type="checkbox" name="by-checkbox" value="utilities" class="cotas checkbox-9">
                    <label htmlFor="">Utilities</label>
                </div>
            </div>
            
            <div class="filter-by-column-name">
                <select id="filter-by-col-name" class="filter-by-col-name">
                    <option value="default">Order by ...</option>
                    <option value="item_name">Item Name</option>
                    <option value="price">Price</option>
                    <option value="quantity">Quantity</option>
                    <option value="category">Category</option>
                    <option value="priority">Priority</option>
                </select>
                <div class="filter-by-column-name-checkbox">
                    <div class="name-checkbox">
                        <label htmlFor="">Descending</label>
                        <input type="checkbox" name="by-checkbox" value="descending" class="descending">
                    </div>
                </div>
            </div>
            
            <span class="item-to-update-text"></span>
            <div class="edit-item-div" style="display:none">
                <input type="text" class="item-name">
                <input type="number" step=0.01 min=0.0 class="item-price">
                <input type="number" min=0 class="item-quantity">
                <!-- <input type="text" class="item-category"> -->
                <select name="item-category" id="item-category" class="item-category" required>
                    <option value="hygien">Hygien</option>
                    <option value="food">Food</option>
                    <option value="clothes">Clothes</option>
                    <option value="documents">Documents</option>
                    <option value="family">Family</option>
                    <option value="debt">Debt</option>
                    <option value="house">House</option>
                    <option value="cotas">Cotas</option>
                </select>
                
                <select name="item-priority" id="item-priority" class="item-priority" required>
                    <option value="low">Low</option>
                    <option value="moderate">Moderate</option>
                    <option value="critical">Critical</option>
                </select>
                <input type="submit" class="update-item-btn" value="Update">
            </div>
            
            <span class="color-reveal"></span>
            <br/>
            <div class="table-div" style="width:949px">
                <table>
                    <thead>
                        <tr>
                            <th>Item Name</th>
                            <th>Price (MZN)</th>
                            <th>Quantity</th>
                            <th>Category</th>
                            <th>Urgent</th>
                            <th>Priority</th>
                            <th>Edit/Delete</th>
                            <!--
                            <th>Created at</th>
                            <th>Updated at</th>
                            -->
                        </tr>
                    </thead>
                    <tbody class="tbody">
                        <tr>
                            <td colspan="1">Total</td>
                            <td>{{ item1.total_amount }}</td>
                            <td colspan="4">Remaining: {{ item1.credit }} MZN</td>
                        </tr>
                        {% for item in items %}
                            <tr>
                                <td>{{ item.item_name }}</td>
                                <td>{{ item.price }}</td>
                                <td>{{ item.quantity }}</td>
                                <td>{{ item.category|title }}</td>
                                <td class="urgent-td">
                                    {% if item.urgent %}
                                        <span class="urgent-item">Yes</span>
                                    {% else %}
                                        <span class="not-urgent-item">No</span>
                                    {% endif %}
                                </td>
                                <td class="priority-td">
                                    <span class="priority {{ item.priority }}" 
                                        title="{{ item.priority }}"
                                        onclick=reviewColor("{{ item.priority }}")
                                    ></span>
                                </td>
                                <td>
                                    <a href="#" class="edit-{{ item.pk }}">Edit</a>
                                    <a class="delete" href="{% url 'portal:delete_item' item.pk %}">Delete</a>
                                </td>
                                <!--
                                <td>{{ item.created_at }}</td>
                                <td>{{ item.updated_at }}</td>
                                -->
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <script src="{% static 'jquery-3.6.1.js' %}"></script>
    <script>
        let color_reveal = document.querySelector(".color-reveal");
        let filter_by_category = document.querySelector(".filter-by-category");
        let filter_by_priority = document.querySelector(".filter-by-priority");
        let tbody = document.querySelector(".tbody");
        let item_to_update_text = document.querySelector(".item-to-update-text");
        let edit_item_div = document.querySelector(".edit-item-div");
        let filter_by_col_name = document.querySelector(".filter-by-col-name");
        let name_checkbox = document.querySelector(".name-checkbox");
        let filters = [];
        var csrftoken = "{{ csrf_token }}";
        
        filter_by_col_name.addEventListener("change", e => {
            let columnName = e.target.value;
            if (columnName !== 'default') {
                fetch(`/all_items_order_by/${columnName}/`)
                    .then(res => res.json())
                    .then(data => {
                        let items = data.items;
                        recreateTable(items);
                        // name_checkbox.style.display = "flex";
                    })
                    .catch(err => console.log(err));
            } 
                
        });
        
        function fillAndUpdate(item) {
            item_to_update_text.textContent = "";

            let item_name = document.querySelector(".item-name");
            let item_price = document.querySelector(".item-price");
            let item_quantity = document.querySelector(".item-quantity");
            let item_category = document.querySelector(".item-category");
            let item_priority = document.querySelector(".item-priority");
            
            item_name.value = item.item_name;
            item_price.value = item.price;
            item_quantity.value = item.quantity;
            item_category.value = item.category;
            item_priority.value = item.priority;
            item_to_update_text.innerHTML = `<span>Updating <b>${item.item_name}</b></span>`;
            
            
            let update_item_btn = document.querySelector(".update-item-btn");
            update_item_btn.addEventListener("click", e => {
                e.preventDefault();
                
                let data = {
                    id: item.id,
                    item_name: item_name.value ,
                    price: item_price.value,
                    quantity: item_quantity.value,
                    category: item_category.value,
                    priority: item_priority.value
                }
            
                fetch("/update_item/", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": csrftoken
                    },
                    mode: "same-origin",
                    body: JSON.stringify({
                        data
                    })
                })
                    .then(res => res.json())
                    .then(data => {
                        // console.log(data.data);
                        
                        setTimeout(() => {
                            edit_item_div.style.display = "none";
                            window.location.reload();
                        }, 1000);
                    })
                    .catch(err => console.log(err));
            })
        }
        
        
        loadUpdateFunction();
        function loadUpdateFunction() {
            fetch("/get_all_items/")
                .then(res => res.json())
                .then(data => {
                    let items = data.items;
                    for (let item of items) {
                        let edit_item = document.querySelector(`.edit-${item.id}`);
                        edit_item.addEventListener("click", e => {
                            edit_item_div.style.display = "block";
                            fillAndUpdate(item)
                        })
                    }
                })
                .catch(err => console.log(err));
        }
            
            
            
        function loadUpdateFunction2(items) {
            for (let item of items) {
                let edit_item = document.querySelector(`.edit-${item.id}`);
                edit_item.addEventListener("click", e => {
                    edit_item_div.style.display = "block";
                    fillAndUpdate(item)
                })
            }
        }
            
        
        /*
        for (let id of [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]) {
            let edit_item = document.querySelector(`.edit-${id}`);
            edit_item.addEventListener("click", e => {
                let edit_item_div = document.querySelector(".edit-item-div");
                edit_item_div.style.display = "block";
                
                fetch(`/get_item_by_pk/${id}/`)
                    .then(res => res.json())
                    .then(data => {
                        console.log(data.item);
                    })
                    .catch(err => console.log(err));
            });
        }
        */
        
        
        function runCheckBox(index) {
            filters = [];
            let checkbox = document.querySelector(`.checkbox-${index}`);
            checkbox.addEventListener("change", e => {
                let value = e.target.value;
                if (e.target.checked) {
                    filters.push(value);
                } else {
                    filters = filters.filter(filter => filter != value)
                }
                sentFilters(filters);
                // console.log(filters);
            });
        }
        
        for (let index of [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12]) {
            runCheckBox(index)
        }
        
        
        function sentFilters(filters) {
            fetch("/get_categories/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": csrftoken
                },
                mode: "same-origin",
                body: JSON.stringify({
                    filters: filters
                })
            })
                .then(res => res.json())
                .then(data => {
                    // console.log(data);
                    recreateTable(data.data);
                })
                .catch(err => console.log(err));
        }
        
        const getTotal = data => {
            let total = 0;
            for (let item of data) {
                total += parseFloat(item.price);
            }
            return total;
        }
        
        function capitalize(word) {
            word = word[0].toUpperCase() + word.slice(1);
            return word
        }
        
        function recreateTable(data) {
            tbody.innerHTML = "";
            let item1 = data[0];
            let total = getTotal(data);
            let remaining = 39400 - parseFloat(total);
            
            let tr = document.createElement("tr");
            tr.innerHTML = `
                <tr>
                    <td colspan="1">Total</td>
                    <td>${ total }</td>
                    <td colspan="2">Remaining: ${ remaining } MZN</td>
                </tr>
            `;
            tbody.appendChild(tr);
            
            for (let item of data) {    
                let category = capitalize(item.category);
                let priority = capitalize(item.priority);
                
                urgent_data = {}
                if (item.urgent) {
                    urgent_data.value = "Yes"
                    urgent_data.className = "urgent-item"
                } else {
                    urgent_data.value = "No"
                    urgent_data.className = "not-urgent-item"
                }
                
                let tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${ item.item_name }</td>
                    <td>${ item.price }</td>
                    <td>${ item.quantity }</td>
                    <td>${ category }</td>
                    <td class="urgent-td">
                        <span class="${ urgent_data.className }">
                            ${ urgent_data.value }
                        </span>
                    </td>
                    <td class="priority-td">
                        <span class="priority ${ item.priority }" 
                            title="${ item.priority }"
                            onclick=reviewColor("${ item.priority }")
                        ></span>
                    </td>
                    <td>
                        <a href="#" class="edit-${ item.id }">Edit</a>
                        <a class="delete" href="delete_item/${item.id}">Delete</a>
                    </td>
                `;
                tbody.appendChild(tr);
            }
            
            setTimeout(() => {
                loadUpdateFunction2(data);
            }, 1500);
        }
        
        /*
        filter_by_priority.addEventListener("input", e => {
            let category = e.target.value;
            
            for (let index of [1, 2, 3, 4, 5]) {
                let checkbox = document.querySelector(`.checkbox-${index}`);
                checkbox.checked = false;
            }
            
            fetch(`/all_things_to_buy_by_priority/${category}/`)
                .then(res => res.json())
                .then(data => {
                    let items = data.items;
                    recreateTable(items);
                })
                .catch(err => console.log(err));
        });
        */
        
        /*
        filter_by_category.addEventListener("input", e => {
            let category = e.target.value;
            
            for (let index of [1, 2, 3, 4, 5]) {
                let checkbox = document.querySelector(`.checkbox-${index}`);
                checkbox.checked = false;
            }
            
            fetch(`/all_things_to_buy_by_category/${category}/`)
                .then(res => res.json())
                .then(data => {
                    let items = data.items;
                    recreateTable(items);
                })
                .catch(err => console.log(err));
        });
        */
        
        
        
        function reviewColor(colorName) {
            color_reveal.textContent = "";
            color_reveal.textContent = colorName.toUpperCase() + " priority!";
        }
    </script>
</body>
</html>



















